# 视频学习管理器 - 系统架构设计

## 整体架构

### 技术栈确认
- **前端**: Vue.js 3 + Element Plus + Axios
- **后端**: Python + FastAPI + SQLite
- **AI引擎**: Faster-Whisper
- **视频处理**: yt-dlp + FFmpeg
- **任务队列**: Redis + Celery
- **部署**: Debian + Nginx + Gunicorn

### 系统架构图
```
┌─────────────────────────────────────────────────────────────┐
│                        Nginx                                │
│                    (反向代理)                                │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                  Frontend                                   │
│              Vue.js + Element Plus                          │
│              (端口: 8080)                                   │
└─────────────────────┬───────────────────────────────────────┘
                      │ HTTP API
┌─────────────────────▼───────────────────────────────────────┐
│                   Backend                                   │
│                FastAPI Server                               │
│                (端口: 8000)                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  API Router │  │ Video Mgmt  │  │  Auth Mgmt  │        │
│  │             │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ├────────────────┐
                      │                │
┌─────────────────────▼──┐   ┌─────────▼────────────────────┐
│     SQLite Database    │   │      Task Queue             │
│                        │   │   Redis + Celery Worker     │
│  ┌─────────────────┐   │   │                             │
│  │     Videos      │   │   │  ┌─────────────────────┐    │
│  │   Transcripts   │   │   │  │   Video Download    │    │
│  │     Users       │   │   │  │   Subtitle Extract  │    │
│  │     Tasks       │   │   │  │   Content Process   │    │
│  └─────────────────┘   │   │  └─────────────────────┘    │
└────────────────────────┘   └──────────────────────────────┘
                                            │
                              ┌─────────────▼─────────────┐
                              │       AI Services         │
                              │                           │
                              │  ┌─────────────────────┐  │
                              │  │   Faster-Whisper   │  │
                              │  │   (字幕提取)        │  │
                              │  └─────────────────────┘  │
                              │  ┌─────────────────────┐  │
                              │  │      yt-dlp        │  │
                              │  │   (视频下载)        │  │
                              │  └─────────────────────┘  │
                              │  ┌─────────────────────┐  │
                              │  │      FFmpeg        │  │
                              │  │   (音频提取)        │  │
                              │  └─────────────────────┘  │
                              └───────────────────────────┘
```

## 数据库设计

### 1. Videos 表 (视频信息)
```sql
CREATE TABLE videos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    url VARCHAR(500) NOT NULL UNIQUE,           -- 原始视频链接
    title VARCHAR(200),                         -- 视频标题
    platform VARCHAR(50) NOT NULL,             -- 平台 (weixin, douyin, bilibili, etc.)
    thumbnail_url VARCHAR(500),                 -- 缩略图链接
    duration INTEGER,                           -- 视频时长（秒）
    file_size INTEGER,                          -- 文件大小（字节）
    local_path VARCHAR(300),                    -- 本地存储路径
    status VARCHAR(20) DEFAULT 'pending',       -- processing, completed, failed
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_url (url),
    INDEX idx_platform (platform),
    INDEX idx_status (status)
);
```

### 2. Transcripts 表 (字幕内容)
```sql
CREATE TABLE transcripts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    video_id INTEGER NOT NULL,
    original_text TEXT NOT NULL,               -- 原始字幕文本
    cleaned_text TEXT,                         -- 清理后的文本
    summary TEXT,                              -- AI生成的摘要
    tags VARCHAR(200),                         -- 标签，逗号分隔
    language VARCHAR(10) DEFAULT 'zh',         -- 语言代码
    confidence_score FLOAT,                    -- 置信度分数
    processing_time INTEGER,                   -- 处理耗时（秒）
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (video_id) REFERENCES videos(id) ON DELETE CASCADE,
    INDEX idx_video_id (video_id)
);
```

### 3. Learning_Records 表 (学习记录)
```sql
CREATE TABLE learning_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    video_id INTEGER NOT NULL,
    learning_status VARCHAR(20) DEFAULT 'todo', -- todo, learning, completed
    practice_status VARCHAR(20) DEFAULT 'none', -- none, planning, implementing, completed
    notes TEXT,                                -- 学习笔记
    code_repo VARCHAR(200),                    -- 实践代码仓库链接
    priority INTEGER DEFAULT 3,               -- 优先级 1-5
    estimated_time INTEGER,                    -- 预计学习时长（分钟）
    actual_time INTEGER,                       -- 实际学习时长（分钟）
    started_at DATETIME,                       -- 开始学习时间
    completed_at DATETIME,                     -- 完成时间
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (video_id) REFERENCES videos(id) ON DELETE CASCADE,
    INDEX idx_video_id (video_id),
    INDEX idx_learning_status (learning_status),
    INDEX idx_practice_status (practice_status)
);
```

### 4. Tasks 表 (异步任务管理)
```sql
CREATE TABLE tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id VARCHAR(50) UNIQUE NOT NULL,       -- Celery任务ID
    video_id INTEGER,
    task_type VARCHAR(30) NOT NULL,            -- download, extract, transcribe
    status VARCHAR(20) DEFAULT 'pending',      -- pending, running, completed, failed
    progress INTEGER DEFAULT 0,                -- 进度百分比
    error_message TEXT,                        -- 错误信息
    result TEXT,                               -- 任务结果(JSON)
    started_at DATETIME,
    completed_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (video_id) REFERENCES videos(id) ON DELETE CASCADE,
    INDEX idx_task_id (task_id),
    INDEX idx_status (status),
    INDEX idx_task_type (task_type)
);
```

### 5. Categories 表 (分类管理)
```sql
CREATE TABLE categories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(50) NOT NULL UNIQUE,          -- 分类名称
    description TEXT,                          -- 分类描述
    color VARCHAR(7) DEFAULT '#666666',        -- 分类颜色
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE video_categories (
    video_id INTEGER NOT NULL,
    category_id INTEGER NOT NULL,
    PRIMARY KEY (video_id, category_id),
    FOREIGN KEY (video_id) REFERENCES videos(id) ON DELETE CASCADE,
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE CASCADE
);
```

## API 接口设计

### 1. 视频管理接口
```python
# 添加视频
POST /api/videos
{
    "url": "https://v.douyin.com/xxxxx",
    "category_ids": [1, 2]
}

# 获取视频列表
GET /api/videos?page=1&size=20&status=completed&platform=douyin

# 获取视频详情
GET /api/videos/{video_id}

# 更新视频信息
PUT /api/videos/{video_id}
{
    "title": "新标题",
    "category_ids": [1, 3]
}

# 删除视频
DELETE /api/videos/{video_id}
```

### 2. 字幕管理接口
```python
# 获取字幕内容
GET /api/videos/{video_id}/transcript

# 更新字幕内容
PUT /api/videos/{video_id}/transcript
{
    "cleaned_text": "清理后的文本",
    "summary": "摘要内容",
    "tags": "Python,教程,Web开发"
}
```

### 3. 学习管理接口
```python
# 获取学习记录
GET /api/learning/{video_id}

# 更新学习状态
PUT /api/learning/{video_id}
{
    "learning_status": "learning",
    "notes": "学习笔记",
    "estimated_time": 120
}

# 获取学习统计
GET /api/learning/stats
```

### 4. 任务管理接口
```python
# 获取任务状态
GET /api/tasks/{task_id}

# 获取任务列表
GET /api/tasks?video_id=123&status=running
```

## 核心业务流程

### 1. 视频处理流程
```python
def process_video(url: str, category_ids: List[int] = None):
    # 1. 创建视频记录
    video = create_video_record(url)
    
    # 2. 异步任务：下载视频
    download_task = download_video.delay(video.id, url)
    
    # 3. 任务链：下载 -> 提取音频 -> 字幕识别
    chain = (
        download_video.s(video.id, url) |
        extract_audio.s() |
        transcribe_audio.s() |
        process_transcript.s()
    )
    
    result = chain.apply_async()
    return video.id, result.id
```

### 2. 字幕处理流程
```python
def transcribe_audio(audio_path: str):
    # 1. 加载Whisper模型
    model = WhisperModel("medium", device="cpu")
    
    # 2. 转录音频
    segments, info = model.transcribe(audio_path)
    
    # 3. 处理转录结果
    transcript = process_segments(segments)
    
    # 4. 生成摘要和标签
    summary = generate_summary(transcript)
    tags = extract_tags(transcript)
    
    return {
        "original_text": transcript,
        "summary": summary,
        "tags": tags,
        "language": info.language,
        "confidence": info.language_probability
    }
```

## 文件存储策略

### 目录结构
```
/var/video-learning-manager/
├── uploads/                # 临时上传目录
├── videos/                 # 视频文件存储
│   ├── 2024/
│   │   ├── 01/            # 按月份存储
│   │   └── 02/
├── audios/                 # 提取的音频文件
├── thumbnails/             # 缩略图
├── logs/                   # 日志文件
└── backups/               # 数据库备份
```

### 文件命名规则
- 视频文件: `{video_id}_{timestamp}.{ext}`
- 音频文件: `{video_id}_audio.wav`
- 缩略图: `{video_id}_thumb.jpg`

## 部署架构

### Docker 化部署 (推荐)
```yaml
version: '3.8'
services:
  web:
    build: .
    ports:
      - "8000:8000"
    depends_on:
      - redis
  
  worker:
    build: .
    command: celery -A app.celery worker --loglevel=info
    depends_on:
      - redis
  
  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
  
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
```

### 传统部署
```bash
# 系统依赖
apt-get update
apt-get install -y python3 python3-pip redis-server nginx ffmpeg

# Python 依赖
pip install fastapi uvicorn celery redis faster-whisper yt-dlp

# 服务配置
systemctl enable redis-server
systemctl enable nginx
```

这个架构设计如何？是否需要调整某些部分？